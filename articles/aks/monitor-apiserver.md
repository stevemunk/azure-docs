---
title: Monitor and query Azure Kubernetes Service (AKS) apiserver requests
description: This article describes how to monitor Azure Kubernetes Service (AKS) kube-audit to query the various types of requests to apiserver.
ms.topic: article
ms.date: 05/08/2023

---

# Monitor and query Azure Kubernetes Service (AKS) apiserver requests

This article describes how to use [Azure Diagnostics][azure-diagnostics-overview] to enable logging for [kube-audit][kube-audit-overview] events generated by user and application activities by the [kube-apiserver][kube-apiserver-overview] component. Audit events written to the Kubernetes Audit backend are collected and forwarded to your Log Analytics workspace, where you can integrate them into queries, alerts, and visualizations with existing log data.

## Before you begin

* A [Log Analytics workspace][log-analytics-workspace-overview]. If you already have a cluster monitored by [Container insights][container-insights-overview], consider using that one. For more information, see [Designing your Azure Monitor Logs deployment][design-log-analytics-deployment].

## Collect Kubernetes audit logs

Kubernetes audit logging isn't enabled by default on an AKS cluster on account of Microsoft manages the AKS control plane. You can create diagnostic settings for your cluster resource using any one of the multiple methods described in the [Create diagnostic settings][create-diagnostic settings] article. While configuring diagnostic settings, specify the following:

* **Logs and metrics to route:** For logs, choose the category **Kubernetes Audit** to send to the destination specified later.
* **Destination details:** Select the checkbox for **Log Analytics**.

> [!NOTE]
> There could be substantial cost involved once kube-audit logs are enabled. Consider disabling kube-audit logging when not required. An alternative approach to significantly reduce the number of logs and help reduce cost is by enabling collection from kube-audit-admin, which excludes the get and list audit events.
> For strategies to reduce your Azure Monitor costs, see [Cost optimization and Azure Monitor][cost-optimization-azure-monitor].

After a few moments, the new setting appears in your list of settings for this resource. Logs are streamed to the specified destinations as new event data is generated. It might take up to 15 minutes between when an event is emitted and when it appears in a [Log Analytics workspace][log-analytics-workspace-overview].

After creating the diagnostic setting to collect kube-audit events, the data can be queried from the [AzureDiagnostics][azure-diagnostics-table] table.

## Query the apiserver requests

It's often useful to build queries that start with an example or two and then modify them to fit your requirements. To help build more advanced queries, you can experiment with the following sample query.

```kusto
let starttime = datetime("2023-02-23");
let endtime = datetime("2023-02-24");
AzureDiagnostics
| where TimeGenerated between(starttime..endtime)
| where Category == "kube-audit"
| extend event = parse_json(log_s)
| extend HttpMethod = tostring(event.verb)
| extend User = tostring(event.user.username)
| extend Apiserver = pod_s
| extend SourceIP = tostring(event.sourceIPs[0])
| project TimeGenerated, Category, HttpMethod, User, Apiserver, SourceIP, OperationName, event
```

## Next steps

For more information about AKS metrics, logs, and other important values, see [Monitoring AKS data reference][monitoring-aks-data-reference].

<!-- LINKS - external -->
[kube-audit-overview]: https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/
[kube-apiserver-overview]: https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/

<!-- LINKS - internal -->
[azure-diagnostics-overview]: ../azure-monitor/essentials/diagnostic-settings.md
[log-analytics-workspace-overview]: ../azure-monitor/logs/log-analytics-workspace-overview.md
[design-log-analytics-deployment]: ../azure-monitor/logs/design-logs-deployment.md
[create-diagnostic settings]: ../azure-monitor/essentials/diagnostic-settings.md#create-diagnostic-settings
[cost-optimization-azure-monitor]: ../azure-monitor/best-practices-cost.md
[azure-diagnostics-table]: /azure/azure-monitor/reference/tables/azurediagnostics
[container-insights-overview]: ..//azure-monitor/containers/container-insights-overview.md
[monitoring-aks-data-reference]: monitor-aks-reference.md
